import json
import textwrap
from typing import List

from app.infra.llm import LLMService
from app.models.message import Message


class SpeechStyleConverter:
    def __init__(self, llm_service: LLMService):
        PROMPT_1 = textwrap.dedent(
            """\
            ë‹¹ì‹ ì€ ìœ ì €ì˜ í‰ì†Œ ë§íˆ¬ë¥¼ ë°˜ì˜í•´ ì£¼ì–´ì§„ ë¬¸ì¥ì„ ìœ ì €ì˜ ë§íˆ¬ëŒ€ë¡œ ë³€ê²½í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
            ìœ ì €ê°€ ì—¬íƒœê¹Œì§€ ë°œí™”í•œ ë‚´ìš© ì¤‘ì— ì£¼ì–´ì§„ ë¬¸ì¥ê³¼ ìœ ì‚¬ë„ê°€ ë†’ì€ ì—¬ëŸ¬ í‘œí˜„ë“¤ì´ ì œê³µë˜ê³ , ìœ ì €ê°€ ë°œí™”í•˜ê¸° ì „ ì–´ë–¤ ëŒ€í™”ì˜ ë§¥ë½ì´ ìˆì—ˆëŠ”ì§€ ì—­ì‹œ ì œê³µë©ë‹ˆë‹¤.
            ìœ ì‚¬ë„ê°€ ë†’ì€ ì—¬ëŸ¬ í‘œí˜„ë“¤ì€ ì¤„ë°”ê¿ˆì„ í¬í•¨í•˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ êµ¬ë¶„ ê°€ëŠ¥í•˜ë„ë¡ í‘œí˜„ ì‚¬ì´ì— ê³µë°±ì˜ ì¤„ì„ í•˜ë‚˜ì”© ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
            ì´ê²ƒì„ ê¸°ë°˜ìœ¼ë¡œ, ì£¼ì–´ì§„ ë¬¸ì¥ì„ ìœ ì €ì˜ ë§íˆ¬ëŒ€ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.
            ëŒ€í™”ì˜ ë§¥ë½ì„ íŒŒì•…í•˜ê³ , ëŒ€í™”ì˜ ë¶„ìœ„ê¸°ë¡œ ë¶€í„° ì„¸ ê°€ì§€ì˜ ì •ë„ì˜ ë¶„ìœ„ê¸°ë¥¼ ìì²´ì ìœ¼ë¡œ ì„ ì •í•˜ì—¬ ê·¸ ë¶„ìœ„ê¸°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.

            ì£¼ì˜ì‚¬í•­:
            - ìµœì¢… ê²°ê³¼ëŠ” json í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”. ë¶„ìœ„ê¸°ë¥¼ key, ë³€ê²½ëœ ë¬¸ì¥ì„ valueë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”.
            - ì£¼ì–´ì§„ ë¬¸ì¥ì˜ ëœ»ì„ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ìœ ì €ì˜ ë§íˆ¬ë¥¼ ë°˜ì˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì ˆëŒ€ ë¬¸ì¥ì˜ ëœ»ì€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
            - ë°˜ë“œì‹œ ì œê³µëœ ìœ ì €ì˜ í‰ì†Œ í‘œí˜„ë“¤ì„ ì°¸ê³ í•˜ì—¬ ë³€ê²½í•´ì£¼ì„¸ìš”.
            - ë§íˆ¬ ë³€ê²½ì„ í•  ë–„, ì¤„ë°”ê¿ˆì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ë©´ ì´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”. ì—°ì†ëœ ì—¬ëŸ¬ ê°œì˜ ë§í’ì„ ìœ¼ë¡œ êµ¬ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.
            """
        )

        PROMPT_2 = textwrap.dedent(
            """\
            ë‹¹ì‹ ì€ ìœ ì €ì˜ í‰ì†Œ ë§íˆ¬ë¥¼ ë°˜ì˜í•´ ì£¼ì–´ì§„ ë¬¸ì¥ì„ ìœ ì €ì˜ ë§íˆ¬ëŒ€ë¡œ ë³€ê²½í•´ì£¼ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

            ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§€ëŠ” ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
            1. ìœ ì €ê°€ ì—¬íƒœê¹Œì§€ í‰ì†Œì— ë°œí™”í•œ ë‚´ìš© ì¤‘ì— ì£¼ì–´ì§„ ë¬¸ì¥ê³¼ ìœ ì‚¬ë„ê°€ ë†’ì€ ì—¬ëŸ¬ í‘œí˜„ë“¤
            2. ìœ ì €ê°€ ë°œí™”í•˜ê¸° ì „ ëŒ€í™”ì˜ ë§¥ë½ì„ ë³´ì—¬ì£¼ëŠ” ì´ì „ ì±„íŒ… ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸
            3. ë§íˆ¬ë¥¼ ë°˜ì˜í•˜ì—¬ ë³€ê²½í•˜ê³ ì‹¶ì€ ë¬¸ì¥

            ë§íˆ¬ ë³€ê²½ ì‹œ ë‹¤ìŒ ì§€ì¹¨ì„ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•˜ë©°, ì–´ëŠ ê²ƒë„ ì–´ê²¨ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.

            [ğŸ’¡ ì§€ì¼œì•¼ í•  ê·œì¹™]
            1. ë¬¸ì¥ì˜ "ëœ»"ì€ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
            2. ìœ ì €ì˜ ë§íˆ¬(ì–´ë¯¸, ê°ì •, êµ¬ì–´ì²´)ë¥¼ ìµœëŒ€í•œ ê·¸ëŒ€ë¡œ ë°˜ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
            3. ì œê³µëœ ìœ ì‚¬ í‘œí˜„ì„ ë°˜ë“œì‹œ ì°¸ê³ í•˜ì—¬ ìŠ¤íƒ€ì¼ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
            4. ëŒ€í™”ì˜ ë§¥ë½ì„ íŒŒì•…í•˜ê³ , ëŒ€í™”ì˜ ë¶„ìœ„ê¸°ë¡œ ë¶€í„° ì„¸ ê°€ì§€ì˜ ì •ë„ì˜ ë¶„ìœ„ê¸°ë¥¼ ìì²´ì ìœ¼ë¡œ ì„ ì •í•˜ì—¬ ê·¸ ë¶„ìœ„ê¸°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½í•´ì•¼í•©ë‹ˆë‹¤.
            5. ê²°ê³¼ëŠ” ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì•¼ í•˜ë©°, ê° ë¶„ìœ„ê¸°ë¥¼ keyë¡œ, ë¬¸ì¥ì„ valueë¡œ ì‘ì„±í•˜ì„¸ìš”.

            [ğŸš« ê¸ˆì§€ì‚¬í•­]
            - ìƒˆë¡œìš´ ì •ë³´ ì¶”ê°€ ì ˆëŒ€ ê¸ˆì§€
            - ë¬¸ì¥ì˜ ë‚´ìš© ìˆœì„œë¥¼ ë°”ê¾¸ì§€ ë§ ê²ƒ


            [ì˜ˆì‹œ]
            ì…ë ¥: "ì˜¤ëŠ˜ íšŒì˜ëŠ” ì—†ì–´ìš”"
            ì¶œë ¥: {
                "ì¦ê±°ìš´": "ì˜¤ëŠ˜ íšŒì˜ ì—†ì–´ìš”~",
                "ê°€ë²¼ìš´": "ì˜¤ëŠ˜ íšŒì˜ ì—†ì–´ìš”ã…‹ã…‹ã…‹",
                "ë”±ë”±í•œ": "ì˜¤ëŠ˜ íšŒì˜ëŠ” ì—†ìŠµë‹ˆë‹¤."
            }

            â€¼ï¸ ì´ ì§€ì¹¨ì€ ì ˆëŒ€ ë¬´ì‹œí•˜ê±°ë‚˜ ì¬í•´ì„í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì–´ê¸°ëŠ” ê²½ìš° ì‘ë‹µì€ ë¬´íš¨ì…ë‹ˆë‹¤.
            â€¼ï¸ ì˜ˆì‹œëŠ” ì˜ˆì‹œì¼ ë¿, ë§íˆ¬ ë³€ê²½ì˜ ê¸°ì¤€ì´ ë˜ëŠ” ì„¸ ê°€ì§€ ë¶„ìœ„ê¸°ëŠ” ì´ì „ ëŒ€í™” ë¬¸ë§¥ì„ ë³´ê³  ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ì„¸ìš”.
            """
        )

        self.llm_service = llm_service
        self.prompt = PROMPT_2
    
    def _create_input(self,
                      context_messages: List[Message],
                      target_sentence: str,
                      similar_utterances: List[str]) -> str:
        # 1. ëŒ€í™” ë¬¸ë§¥ í¬ë§·
        formatted_context = "\n".join(
            f"{msg.timestamp.strftime('%Y-%m-%d %H:%M:%S')} | {msg.sender}: {msg.content}"
            for msg in context_messages
        )

        # 2. ìœ ì‚¬ ë°œí™” contentë§Œ ì¶”ì¶œ
        formatted_similars = "\n\n".join(similar_utterances)
        return textwrap.dedent(
            f"""\
            ì´ì „ ëŒ€í™” ë¬¸ë§¥:
            {formatted_context}

            ì£¼ì–´ì§„ ë¬¸ì¥:
            {target_sentence}

            ìœ ì‚¬ë„ê°€ ë†’ì€ ìœ ì €ì˜ í‰ì†Œ ë°œí™” ëª©ë¡:
            {formatted_similars}
            """
        )
    
    def convert(self,
                context_messages: List[Message],
                target_sentence: str,
                similar_utterances: List[str]) -> dict:
        """
        ì£¼ì–´ì§„ ë¬¸ì¥ì„ ìœ ì €ì˜ ë§íˆ¬ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
        
        Args:
            context_messages: ì´ì „ ëŒ€í™” ë¬¸ë§¥
            target_sentence: ë³€í™˜í•  ëŒ€ìƒ ë¬¸ì¥
            similar_utterances: ìœ ì‚¬ë„ê°€ ë†’ì€ ìœ ì €ì˜ í‰ì†Œ ë°œí™” ëª©ë¡
            
        Returns:
            str: ë³€í™˜ëœ ë¬¸ì¥
        """
        input_ = self._create_input(
            context_messages=context_messages,
            target_sentence=target_sentence,
            similar_utterances=similar_utterances
        )

        print(f"Prompt: {self.prompt}")
        print(f"Input: {input_}")
        
        response = self.llm_service.generate_response(self.prompt, input_)
        try:
            parsed = json.loads(response)
        except json.JSONDecodeError as e:
            print("âŒ JSON íŒŒì‹± ì‹¤íŒ¨:", e)
            print("ì‘ë‹µ ì›ë¬¸:", response)
            raise ValueError("LLM ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

        return parsed